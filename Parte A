#include <Arduino.h>
#include <LiquidCrystal.h>

// ==== Pines LCD en modo 8 bits ====
#define rs 15
#define en 2
#define d0 4
#define d1 16   // RX2
#define d2 17   // TX2
#define d3 5
#define d4 18
#define d5 19
#define d6 21
#define d7 27

// ==== Potenciómetros ====
#define POT_ROJO 35   // Potenciómetro para LED rojo
#define POT_VERDE 34  // Potenciómetro para LED verde

// ==== LEDs RGB (PWM) ====
#define LED_AZUL 13
#define LED_VERDE 12
#define LED_ROJO 14

// ==== Objeto LCD ====
LiquidCrystal lcd(rs, en, d0, d1, d2, d3, d4, d5, d6, d7);

// ==== Canales PWM para ESP32 ====
#define PWM_CH_ROJO 0
#define PWM_CH_VERDE 1
#define PWM_CH_AZUL 2
#define PWM_FREQ 5000
#define PWM_RES 8   // 8 bits (0-255)

void setup() {
  Serial.begin(115200);   // Comunicación UART

  // Inicializar LCD
  lcd.begin(16, 2);
  lcd.clear();
  lcd.print("Laboratorio UART");

  // Configurar PWM para LEDs
  ledcSetup(PWM_CH_ROJO, PWM_FREQ, PWM_RES);
  ledcSetup(PWM_CH_VERDE, PWM_FREQ, PWM_RES);
  ledcSetup(PWM_CH_AZUL, PWM_FREQ, PWM_RES);

  // Asociar pines
  ledcAttachPin(LED_ROJO, PWM_CH_ROJO);
  ledcAttachPin(LED_VERDE, PWM_CH_VERDE);
  ledcAttachPin(LED_AZUL, PWM_CH_AZUL);
}

void loop() {
  // Leer potenciómetros (0–4095)
  int lecturaRojo = analogRead(POT_ROJO);
  int lecturaVerde = analogRead(POT_VERDE);

  // Escalar a 8 bits (0–255)
  uint8_t valorRojo = map(lecturaRojo, 0, 4095, 0, 255);
  uint8_t valorVerde = map(lecturaVerde, 0, 4095, 0, 255);

  // Enviar por UART
  Serial.print("Intensidad Rojo: ");
  Serial.print(valorRojo);
  Serial.print("\tIntensidad Verde: ");
  Serial.println(valorVerde);

  // Actualizar LEDs con PWM
  ledcWrite(PWM_CH_ROJO, valorRojo);
  ledcWrite(PWM_CH_VERDE, valorVerde);

  // Mostrar en LCD
  lcd.setCursor(0, 1);
  lcd.print("R:");
  lcd.print(valorRojo);
  lcd.print(" V:");
  lcd.print(valorVerde);
  lcd.print("   ");  // Para limpiar sobrantes

  delay(300);
}
